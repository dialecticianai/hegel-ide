<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Hegel IDE</title>
  <link rel="stylesheet" href="node_modules/@xterm/xterm/css/xterm.css" />
  <link rel="stylesheet" href="styles.css" />
  <script src="renderer.js"></script>
</head>
<body>
  <!-- Split-pane layout -->
  <div id="app" x-data="splitPane" class="split-container">
    <!-- Left Panel: Markdown Browser -->
    <div class="split-pane left-pane" :style="{ width: leftPanelPercent + '%' }" @click="lastInteractedPane = 'left'">
      <!-- Tab Bar -->
      <div class="tab-bar">
        <div class="tabs-list">
          <template x-for="tab in leftTabs" :key="tab.id">
            <div class="tab"
                 :class="{ 'active': activeLeftTab === tab.id }"
                 @click="switchLeftTab(tab.id)"
                 :title="tab.type === 'project-detail' && projectDetails[tab.projectName]?.currentFile
                   ? projectDetails[tab.projectName].currentFile
                   : ''">
              <template x-if="tab.type === 'project-detail' && projectDetails[tab.projectName]?.currentFile">
                <span>
                  <span x-text="tab.projectName"></span><span class="tab-separator">: </span><span class="tab-file-path" x-text="compressFilePath(projectDetails[tab.projectName].currentFile)"></span>
                </span>
              </template>
              <template x-if="!(tab.type === 'project-detail' && projectDetails[tab.projectName]?.currentFile)">
                <span x-text="tab.label"></span>
              </template>
              <button x-show="tab.type === 'project-detail'"
                      class="refresh-tab"
                      :class="{ 'spinning': projectDetails[tab.projectName]?.loading }"
                      @click.stop="refreshProjectDetails(tab.projectName)"
                      :disabled="projectDetails[tab.projectName]?.loading"
                      title="Refresh project details">⟳</button>
              <button x-show="tab.type === 'file'"
                      class="refresh-tab"
                      :class="{ 'spinning': fileContents[tab.filePath]?.loading }"
                      @click.stop="refreshFileContent(tab.filePath)"
                      :disabled="fileContents[tab.filePath]?.loading"
                      title="Refresh file">⟳</button>
              <button x-show="tab.closeable"
                      class="close-tab"
                      @click.stop="closeLeftTab(tab.id)">×</button>
            </div>
          </template>
        </div>
        <button class="add-tab" @click="addProjectTab">+</button>
      </div>

      <!-- Tab Content Area -->
      <div class="tab-content">
        <!-- Projects tab content -->
        <div x-show="activeLeftTab === 'projects'" class="tab-content-padded">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
            <h2 style="margin: 0;">Projects</h2>
            <span @click="openSettingsTab" class="settings-icon" title="Settings"></span>
          </div>

          <template x-if="projectsLoading">
            <p>Loading projects...</p>
          </template>

          <template x-if="projectsError">
            <p class="error" x-text="projectsError"></p>
          </template>

          <div class="projects-list" x-show="!projectsLoading && !projectsError">
            <template x-for="project in projects" :key="project.name">
              <div class="project-card">
                <div class="project-card-header">
                  <h3 class="project-name" @click="openProjectTab(project.name)" x-text="project.name"></h3>
                  <span class="info-value" title="Last activity" x-text="formatTimeAgo(project.last_activity)"></span>
                  <button class="collapse-toggle"
                          @click="toggleProjectCollapse(project.name)"
                          :title="isProjectCollapsed(project.name) ? 'Expand' : 'Collapse'">
                    <span x-text="isProjectCollapsed(project.name) ? '▶' : '▼'"></span>
                  </button>
                </div>

                <div x-show="!isProjectCollapsed(project.name)" class="project-card-content">
                  <div class="project-info-row">
                    <span class="info-value info-value-path"
                          x-text="formatPath(project.project_path)"
                          :title="'Path: ' + project.project_path"></span>
                    <span class="project-remove-icon"
                          @click="removeProject(project.name)"
                          title="Remove project from tracking"></span>
                    <span class="metric-sep">|</span>
                    <span class="info-value" title="Cache size" x-text="formatBytes(project.hegel_size_bytes)"></span>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>

        <!-- Settings tab content -->
        <div x-show="activeLeftTab === 'settings'" class="tab-content-padded">
          <h2>Settings</h2>
          <div style="display: flex; flex-direction: column; gap: 16px; margin-top: 20px;">
            <div>
              <label style="display: block; margin-bottom: 8px;">Theme</label>
              <select x-model="currentTheme" @change="setTheme(currentTheme)" class="theme-selector">
                <option value="auto">Auto</option>
                <option value="dark">Dark</option>
                <option value="light">Light</option>
                <option value="synthwave">Synthwave</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 8px;">Debug</label>
              <button @click="toggleDevTools" class="devtools-button">
                Toggle DevTools
              </button>
            </div>
          </div>
        </div>

        <!-- Project detail tabs content -->
        <template x-for="tab in leftTabs.filter(t => t.type === 'project-detail')" :key="tab.id">
          <div x-show="activeLeftTab === tab.id">
            <div x-show="projectDetails[tab.projectName]?.loading">Loading project details...</div>
            <div x-show="projectDetails[tab.projectName]?.error" class="error" x-text="projectDetails[tab.projectName]?.error"></div>

            <!-- Project details card -->
            <div x-show="projectDetails[tab.projectName]?.data" class="project-details-card">
              <template x-if="projectDetails[tab.projectName]?.data">
                <div class="project-info-row">
                  <span class="info-value info-value-path"
                        x-text="formatPath(projectDetails[tab.projectName].data.project_path)"
                        :title="'Path: ' + projectDetails[tab.projectName].data.project_path"></span>
                  <span class="metric-sep">|</span>
                  <span class="info-value" title="Cache size" x-text="formatBytes(projectDetails[tab.projectName].data.hegel_size_bytes)"></span>
                  <span class="metric-sep">|</span>
                  <span class="info-value" title="Last activity" x-text="formatTimeAgo(projectDetails[tab.projectName].data.last_activity)"></span>
                  <span class="metric-sep">|</span>
                  <span class="info-value" title="Workflow" x-text="formatWorkflowState(projectDetails[tab.projectName].data.workflow_state)"></span>
                </div>
              </template>

              <template x-if="projectDetails[tab.projectName]?.data?.metrics">
                <div class="metrics-row">
                  <span class="metrics-label">usage</span>
                  <span class="metric-sep">|</span>
                  <span title="input tokens" x-text="formatNumber(projectDetails[tab.projectName].data.metrics.total_input_tokens) + ' i'"></span>
                  <span class="metric-sep">|</span>
                  <span title="output tokens" x-text="formatNumber(projectDetails[tab.projectName].data.metrics.total_output_tokens) + ' o'"></span>
                  <span class="metric-sep">|</span>
                  <span title="events" x-text="formatNumber(projectDetails[tab.projectName].data.metrics.total_events) + ' e'"></span>
                  <span class="metric-sep">|</span>
                  <span title="phases" x-text="formatNumber(projectDetails[tab.projectName].data.metrics.phase_count) + ' p'"></span>
                </div>
              </template>
            </div>

            <!-- Markdown tree section -->
            <div x-show="projectDetails[tab.projectName]?.data" class="markdown-tree-container">
              <template x-if="projectDetails[tab.projectName]?.markdownTreeLoading">
                <div class="markdown-tree-loading">Fetching document tree...</div>
              </template>
              <template x-if="projectDetails[tab.projectName]?.markdownTreeError">
                <div class="markdown-tree-error" x-text="'Failed to load document tree: ' + projectDetails[tab.projectName].markdownTreeError"></div>
              </template>
              <template x-if="projectDetails[tab.projectName]?.markdownTree">
                <div class="markdown-tree">
                  <div class="markdown-tree-content"
                       x-html="renderMarkdownTree(projectDetails[tab.projectName].markdownTree, projectDetails[tab.projectName].currentFile || 'README.md')"
                       @click="handleTreeClick($event, tab.projectName)"></div>
                </div>
              </template>
            </div>

            <!-- README section -->
            <div x-show="projectDetails[tab.projectName]?.data" class="tab-content-padded">
              <template x-if="projectDetails[tab.projectName]?.readme">
                <div class="markdown-content"
                     x-html="renderMarkdown(projectDetails[tab.projectName].readme, `${projectDetails[tab.projectName].data.project_path}/${projectDetails[tab.projectName].currentFile || 'README.md'}`)"
                     @click="handleMarkdownClick($event, tab.id, tab.projectName)"></div>
              </template>
              <template x-if="!projectDetails[tab.projectName]?.readme && !projectDetails[tab.projectName]?.loading">
                <div class="readme-missing">Project missing README.md</div>
              </template>
            </div>
          </div>
        </template>

        <!-- File tabs content -->
        <template x-for="tab in leftTabs.filter(t => t.type === 'file')" :key="tab.id">
          <div x-show="activeLeftTab === tab.id" class="tab-content-padded">
            <span class="info-value info-value-path"
                  x-text="formatPath(tab.filePath)"
                  :title="'Path: ' + tab.filePath"></span>
            <template x-if="fileContents[tab.filePath]">
              <div>
                <div x-show="fileContents[tab.filePath]?.loading">Loading file...</div>
                <div x-show="fileContents[tab.filePath]?.error"
                     class="error"
                     x-text="fileContents[tab.filePath]?.error"></div>
                <div x-show="fileContents[tab.filePath]?.content"
                     class="markdown-content"
                     x-html="renderMarkdown(fileContents[tab.filePath]?.content, tab.filePath)"
                     @click="handleMarkdownClick($event, tab.id)"></div>
              </div>
            </template>
          </div>
        </template>

        <!-- Review tabs content -->
        <template x-for="tab in leftTabs.filter(t => t.type === 'review')" :key="tab.id">
          <div x-show="activeLeftTab === tab.id" class="review-tab-container">
            <template x-if="fileContents[tab.filePath]">
              <div>
                <div x-show="fileContents[tab.filePath]?.loading" class="tab-content-padded">Loading file...</div>
                <div x-show="fileContents[tab.filePath]?.error"
                     class="error tab-content-padded"
                     x-text="fileContents[tab.filePath]?.error"></div>

                <!-- Review toolbar -->
                <div x-show="fileContents[tab.filePath]?.content" class="review-toolbar">
                  <div class="review-toolbar-info">
                    <span class="review-file-name" x-text="tab.label + '.md'"></span>
                    <span x-show="tab.pendingComments.length > 0" class="review-comment-count" x-text="`${tab.pendingComments.length} comment${tab.pendingComments.length !== 1 ? 's' : ''}`"></span>
                  </div>
                  <div class="review-toolbar-actions">
                    <button class="review-lgtm-button" @click="submitLGTM(tab.id)">LGTM</button>
                    <button class="review-nope-button" @click="submitNope(tab.id)">Nope</button>
                    <button class="review-submit-button" @click="submitReview(tab.id)" :disabled="tab.pendingComments.length === 0">Submit Review</button>
                  </div>
                </div>

                <div x-show="fileContents[tab.filePath]?.content" class="review-grid">
                  <!-- Content area with line-tracked markdown -->
                  <div class="review-content"
                       x-html="window.HegelIDE.parseMarkdownWithLines(fileContents[tab.filePath]?.content, 'html', tab.filePath)"
                       @mouseup="handleReviewSelection(tab.id)"></div>

                  <!-- Comment margin (collapsed by default) -->
                  <div class="comment-margin"
                       :class="{ 'collapsed': tab.marginCollapsed }">
                    <!-- Margin toggle button -->
                    <button class="margin-toggle"
                            @click="toggleCommentMargin(tab.id)"
                            :title="tab.marginCollapsed ? 'Expand margin' : 'Collapse margin'">
                      <span x-text="tab.marginCollapsed ? '◀' : '▶'"></span>
                    </button>

                    <!-- Comment form (shown when selection is active) -->
                    <div x-show="tab.activeCommentForm" class="comment-form">
                      <div class="comment-form-header">
                        <span class="comment-form-lines" x-text="tab.activeCommentForm ? `Lines ${tab.activeCommentForm.lineStart}-${tab.activeCommentForm.lineEnd}` : ''"></span>
                      </div>
                      <div class="comment-form-selected" x-text="tab.activeCommentForm?.selectedText"></div>
                      <textarea class="comment-form-textarea"
                                placeholder="Add your comment..."
                                x-model="tab.activeCommentForm.commentText"
                                rows="4"></textarea>
                      <div class="comment-form-actions">
                        <button @click="addComment(tab.id)" class="comment-form-save">Save</button>
                        <button @click="cancelCommentForm(tab.id)" class="comment-form-cancel">Cancel</button>
                      </div>
                    </div>

                    <!-- Comment cards (stacked) -->
                    <div class="comment-cards-container">
                      <template x-for="(comment, index) in tab.pendingComments" :key="index">
                        <div class="comment-card"
                             :style="`z-index: ${comment.zIndex}; transform: translate(${index * 4}px, ${index * 4}px);`"
                             @click="bringCommentToFront(tab.id, index)">
                          <div class="comment-card-header">
                            <span class="comment-card-lines" x-text="`Lines ${comment.lineStart}-${comment.lineEnd}`"></span>
                            <span class="comment-card-time" x-text="new Date(comment.timestamp).toLocaleTimeString()"></span>
                          </div>
                          <div class="comment-card-selected" x-text="comment.selectedText"></div>
                          <div class="comment-card-text" x-text="comment.comment"></div>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </template>
      </div>
    </div>

    <!-- Draggable Divider -->
    <div class="divider"
         @mousedown="startDrag"
         :class="{ 'dragging': isDragging }">
    </div>

    <!-- Right Panel: Terminal -->
    <div class="split-pane right-pane" :style="{ width: (100 - leftPanelPercent) + '%' }" @click="lastInteractedPane = 'right'">
      <!-- Tab Bar -->
      <div class="tab-bar">
        <div class="tabs-list">
          <template x-for="tab in rightTabs" :key="tab.id">
            <div class="tab"
                 :class="{ 'active': activeRightTab === tab.id }"
                 @click="switchRightTab(tab.id)">
              <span x-text="tab.label"></span>
              <button x-show="tab.closeable"
                      class="close-tab"
                      @click.stop="closeRightTab(tab.id)">×</button>
            </div>
          </template>
        </div>
        <button class="add-tab" @click="addTerminalTab">+</button>
      </div>

      <!-- Terminal Content Area -->
      <div class="tab-content">
        <!-- Show "Open Terminal" button when no terminals exist -->
        <div x-show="rightTabs.length === 0" class="empty-terminal-state">
          <button @click="addTerminalTab" class="open-terminal-button">
            Open Terminal
          </button>
        </div>

        <template x-for="tab in rightTabs" :key="tab.id">
          <div x-show="activeRightTab === tab.id" class="terminal-wrapper">
            <div class="terminal-macros">
              <button class="terminal-macro-button" @click="sendMacro(tab.terminalId, 'LGTM')">LGTM</button>
              <button class="terminal-macro-button" @click="sendMacro(tab.terminalId, 'Proceed')">Proceed</button>
            </div>
            <div :id="'terminal-container-' + tab.terminalId"
                 class="terminal-container"></div>
          </div>
        </template>
      </div>
    </div>
  </div>
</body>
</html>
